{"version":3,"sources":["../src/controllers/window-controller.ts"],"names":[],"mappings":"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","file":"window-controller.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n'use strict';\n\nimport { FirebaseMessaging } from '@firebase/messaging-types';\nimport ControllerInterface from './controller-interface';\nimport Errors from '../models/errors';\nimport WorkerPageMessage from '../models/worker-page-message';\nimport DefaultSW from '../models/default-sw';\nimport NOTIFICATION_PERMISSION from '../models/notification-permission';\nimport FCMDetails from '../models/fcm-details';\nimport base64ToArrayBuffer from '../helpers/base64-to-array-buffer';\nimport { createSubscribe } from '@firebase/util';\n\ndeclare const firebase: any;\n\nexport default class WindowController extends ControllerInterface\n  implements FirebaseMessaging {\n  private registrationToUse_;\n  private publicVapidKeyToUse_;\n  private manifestCheckPromise_;\n  private messageObserver_ = null;\n  private onMessage_ = createSubscribe(observer => {\n    this.messageObserver_ = observer;\n  });\n  private tokenRefreshObserver_ = null;\n  private onTokenRefresh_ = createSubscribe(observer => {\n    this.tokenRefreshObserver_ = observer;\n  });\n\n  /**\n   * A service that provides a MessagingService instance.\n   * @param {!firebase.app.App} app\n   */\n  constructor(app) {\n    super(app);\n\n    /**\n     * @private\n     * @type {ServiceWorkerRegistration}\n     */\n    this.registrationToUse_;\n\n    /**\n     * @private\n     * @type {Promise}\n     */\n    this.manifestCheckPromise_;\n\n    /**\n     * @private\n     * @type {firebase.Observer}\n     */\n    this.messageObserver_ = null;\n\n    /**\n     * @private {!firebase.Subscribe} The subscribe function to the onMessage\n     * observer.\n     */\n    this.onMessage_ = createSubscribe(observer => {\n      this.messageObserver_ = observer;\n    });\n\n    /**\n     * @private\n     * @type {firebase.Observer}\n     */\n    this.tokenRefreshObserver_ = null;\n    this.onTokenRefresh_ = createSubscribe(observer => {\n      this.tokenRefreshObserver_ = observer;\n    });\n\n    this.setupSWMessageListener_();\n  }\n\n  /**\n   * This method returns an FCM token if it can be generated.\n   * The return promise will reject if the browser doesn't support\n   * FCM, if permission is denied for notifications or it's not\n   * possible to generate a token.\n   * @export\n   * @return {Promise<string> | Promise<null>} Returns a promise the\n   * resolves to an FCM token or null if permission isn't granted.\n   */\n  getToken() {\n    // Check that the required API's are available\n    if (!this.isSupported_()) {\n      return Promise.reject(\n        this.errorFactory_.create(Errors.codes.UNSUPPORTED_BROWSER)\n      );\n    }\n\n    return this.manifestCheck_().then(() => {\n      return super.getToken();\n    });\n  }\n\n  /**\n   * The method checks that a manifest is defined and has the correct GCM\n   * sender ID.\n   * @private\n   * @return {Promise} Returns a promise that resolves if the manifest matches\n   * our required sender ID\n   */\n  manifestCheck_() {\n    if (this.manifestCheckPromise_) {\n      return this.manifestCheckPromise_;\n    }\n\n    const manifestTag = <HTMLAnchorElement>document.querySelector(\n      'link[rel=\"manifest\"]'\n    );\n    if (!manifestTag) {\n      this.manifestCheckPromise_ = Promise.resolve();\n    } else {\n      this.manifestCheckPromise_ = fetch(manifestTag.href)\n        .then(response => {\n          return response.json();\n        })\n        .catch(() => {\n          // If the download or parsing fails allow check.\n          // We only want to error if we KNOW that the gcm_sender_id is incorrect.\n        })\n        .then(manifestContent => {\n          if (!manifestContent) {\n            return;\n          }\n\n          if (!manifestContent['gcm_sender_id']) {\n            return;\n          }\n\n          if (manifestContent['gcm_sender_id'] !== '103953800507') {\n            throw this.errorFactory_.create(\n              Errors.codes.INCORRECT_GCM_SENDER_ID\n            );\n          }\n        });\n    }\n\n    return this.manifestCheckPromise_;\n  }\n\n  /**\n   * Request permission if it is not currently granted\n   * @export\n   * @returns {Promise} Resolves if the permission was granted, otherwise\n   * rejects\n   */\n  async requestPermission() {\n    if ((Notification as any).permission === NOTIFICATION_PERMISSION.granted) {\n      return;\n    }\n\n    return new Promise((resolve, reject) => {\n      const managePermissionResult = result => {\n        if (result === NOTIFICATION_PERMISSION.granted) {\n          return resolve();\n        } else if (result === NOTIFICATION_PERMISSION.denied) {\n          return reject(\n            this.errorFactory_.create(Errors.codes.PERMISSION_BLOCKED)\n          );\n        } else {\n          return reject(\n            this.errorFactory_.create(Errors.codes.PERMISSION_DEFAULT)\n          );\n        }\n      };\n\n      // The Notification.requestPermission API was changed to\n      // return a promise so now have to handle both in case\n      // browsers stop support callbacks for promised version\n      const permissionPromise = Notification.requestPermission(\n        managePermissionResult\n      );\n      if (permissionPromise) {\n        // Prefer the promise version as it's the future API.\n        permissionPromise.then(managePermissionResult);\n      }\n    });\n  }\n\n  /**\n   * This method allows a developer to override the default service worker and\n   * instead use a custom service worker.\n   * @export\n   * @param {!ServiceWorkerRegistration} registration The service worker\n   * registration that should be used to receive the push messages.\n   */\n  useServiceWorker(registration) {\n    if (!(registration instanceof ServiceWorkerRegistration)) {\n      throw this.errorFactory_.create(Errors.codes.SW_REGISTRATION_EXPECTED);\n    }\n\n    if (typeof this.registrationToUse_ !== 'undefined') {\n      throw this.errorFactory_.create(Errors.codes.USE_SW_BEFORE_GET_TOKEN);\n    }\n\n    this.registrationToUse_ = registration;\n  }\n\n  /**\n   * This method allows a developer to override the default vapid key\n   * and instead use a custom VAPID public key.\n   * @export\n   * @param {!string} publicKey A URL safe base64 encoded string.\n   */\n  usePublicVapidKey(publicKey) {\n    if (typeof publicKey !== 'string') {\n      throw this.errorFactory_.create(Errors.codes.INVALID_PUBLIC_VAPID_KEY);\n    }\n\n    if (typeof this.publicVapidKeyToUse_ !== 'undefined') {\n      throw this.errorFactory_.create(\n        Errors.codes.USE_PUBLIC_KEY_BEFORE_GET_TOKEN\n      );\n    }\n\n    const parsedKey = base64ToArrayBuffer(publicKey);\n\n    if (parsedKey.length !== 65) {\n      throw this.errorFactory_.create(\n        Errors.codes.PUBLIC_KEY_DECRYPTION_FAILED\n      );\n    }\n\n    this.publicVapidKeyToUse_ = parsedKey;\n  }\n\n  /**\n   * @export\n   * @param {!firebase.Observer|function(*)} nextOrObserver An observer object\n   * or a function triggered on message.\n   * @param {function(!Error)=} optError Optional A function triggered on\n   * message error.\n   * @param {function()=} optCompleted Optional function triggered when the\n   * observer is removed.\n   * @return {!function()} The unsubscribe function for the observer.\n   */\n  onMessage(nextOrObserver, optError?, optCompleted?) {\n    return this.onMessage_(nextOrObserver, optError, optCompleted);\n  }\n\n  /**\n   * @export\n   * @param {!firebase.Observer|function()} nextOrObserver An observer object\n   * or a function triggered on token refresh.\n   * @param {function(!Error)=} optError Optional A function\n   * triggered on token refresh error.\n   * @param {function()=} optCompleted Optional function triggered when the\n   * observer is removed.\n   * @return {!function()} The unsubscribe function for the observer.\n   */\n  onTokenRefresh(nextOrObserver, optError, optCompleted) {\n    return this.onTokenRefresh_(nextOrObserver, optError, optCompleted);\n  }\n\n  /**\n   * Given a registration, wait for the service worker it relates to\n   * become activer\n   * @private\n   * @param  {ServiceWorkerRegistration} registration Registration to wait\n   * for service worker to become active\n   * @return {Promise<!ServiceWorkerRegistration>} Wait for service worker\n   * registration to become active\n   */\n  waitForRegistrationToActivate_(registration) {\n    const serviceWorker =\n      registration.installing || registration.waiting || registration.active;\n\n    return new Promise<ServiceWorkerRegistration>((resolve, reject) => {\n      if (!serviceWorker) {\n        // This is a rare scenario but has occured in firefox\n        reject(this.errorFactory_.create(Errors.codes.NO_SW_IN_REG));\n        return;\n      }\n      // Because the Promise function is called on next tick there is a\n      // small chance that the worker became active or redundant already.\n      if (serviceWorker.state === 'activated') {\n        resolve(registration);\n        return;\n      }\n\n      if (serviceWorker.state === 'redundant') {\n        reject(this.errorFactory_.create(Errors.codes.SW_REG_REDUNDANT));\n        return;\n      }\n\n      let stateChangeListener = () => {\n        if (serviceWorker.state === 'activated') {\n          resolve(registration);\n        } else if (serviceWorker.state === 'redundant') {\n          reject(this.errorFactory_.create(Errors.codes.SW_REG_REDUNDANT));\n        } else {\n          // Return early and wait to next state change\n          return;\n        }\n        serviceWorker.removeEventListener('statechange', stateChangeListener);\n      };\n      serviceWorker.addEventListener('statechange', stateChangeListener);\n    });\n  }\n\n  /**\n   * This will regiater the default service worker and return the registration\n   * @private\n   * @return {Promise<!ServiceWorkerRegistration>} The service worker\n   * registration to be used for the push service.\n   */\n  getSWRegistration_() {\n    if (this.registrationToUse_) {\n      return this.waitForRegistrationToActivate_(this.registrationToUse_);\n    }\n\n    // Make the registration null so we know useServiceWorker will not\n    // use a new service worker as registrationToUse_ is no longer undefined\n    this.registrationToUse_ = null;\n\n    return navigator.serviceWorker\n      .register(DefaultSW.path, {\n        scope: DefaultSW.scope\n      })\n      .catch(err => {\n        throw this.errorFactory_.create(\n          Errors.codes.FAILED_DEFAULT_REGISTRATION,\n          {\n            browserErrorMessage: err.message\n          }\n        );\n      })\n      .then(registration => {\n        return this.waitForRegistrationToActivate_(registration).then(() => {\n          this.registrationToUse_ = registration;\n\n          // We update after activation due to an issue with Firefox v49 where\n          // a race condition occassionally causes the service work to not\n          // install\n          registration.update();\n\n          return registration;\n        });\n      });\n  }\n\n  /**\n   * This will return the default VAPID key or the uint8array version of the public VAPID key\n   * provided by the developer.\n   * @private\n   */\n  getPublicVapidKey_(): Promise<Uint8Array> {\n    if (this.publicVapidKeyToUse_) {\n      return Promise.resolve(this.publicVapidKeyToUse_);\n    }\n\n    return Promise.resolve(FCMDetails.DEFAULT_PUBLIC_VAPID_KEY);\n  }\n\n  /**\n   * Gets a PushSubscription for the current user.\n   * @private\n   * @param {ServiceWorkerRegistration} registration\n   * @return {Promise<PushSubscription>}\n   */\n  getPushSubscription_(swRegistration, publicVapidKey) {\n    // Check for existing subscription first\n    let subscription;\n    let fcmTokenDetails;\n    return swRegistration.pushManager.getSubscription().then(subscription => {\n      if (subscription) {\n        return subscription;\n      }\n\n      return swRegistration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: publicVapidKey\n      });\n    });\n  }\n\n  /**\n   * This method will set up a message listener to handle\n   * events from the service worker that should trigger\n   * events in the page.\n   *\n   * @private\n   */\n  setupSWMessageListener_() {\n    if (!('serviceWorker' in navigator)) {\n      return;\n    }\n\n    navigator.serviceWorker.addEventListener(\n      'message',\n      event => {\n        if (!event.data || !event.data[WorkerPageMessage.PARAMS.TYPE_OF_MSG]) {\n          // Not a message from FCM\n          return;\n        }\n\n        const workerPageMessage = event.data;\n        switch (workerPageMessage[WorkerPageMessage.PARAMS.TYPE_OF_MSG]) {\n          case WorkerPageMessage.TYPES_OF_MSG.PUSH_MSG_RECEIVED:\n          case WorkerPageMessage.TYPES_OF_MSG.NOTIFICATION_CLICKED:\n            const pushMessage =\n              workerPageMessage[WorkerPageMessage.PARAMS.DATA];\n            if (this.messageObserver_) {\n              this.messageObserver_.next(pushMessage);\n            }\n            break;\n          default:\n            // Noop.\n            break;\n        }\n      },\n      false\n    );\n  }\n\n  /**\n   * Checks to see if the required API's are valid or not.\n   * @private\n   * @return {boolean} Returns true if the desired APIs are available.\n   */\n  isSupported_() {\n    return (\n      'serviceWorker' in navigator &&\n      'PushManager' in window &&\n      'Notification' in window &&\n      'fetch' in window &&\n      ServiceWorkerRegistration.prototype.hasOwnProperty('showNotification') &&\n      PushSubscription.prototype.hasOwnProperty('getKey')\n    );\n  }\n}\n"]}