{"version":3,"sources":["../src/models/clean-v1-undefined.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;GAcG;;AAEH;;;;;;;;;;GAUG;AAEH,iDAA2C;AAE3C,IAAM,WAAW,GAAG,WAAW,CAAC;AAChC,IAAM,qBAAqB,GAAG,wBAAwB,CAAC;AAEvD,kBAAkB,EAAe;IAC/B,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC,gBAAgB,CAAC,QAAQ,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACzD,yEAAyE;QACzE,uBAAuB;QACvB,MAAM,CAAC;IACT,CAAC;IAED,IAAM,WAAW,GAAG,EAAE,CAAC,WAAW,CAAC,qBAAqB,CAAC,CAAC;IAC1D,IAAM,WAAW,GAAG,WAAW,CAAC,WAAW,CAAC,qBAAqB,CAAC,CAAC;IAEnE,IAAM,QAAQ,GAAG,IAAI,mBAAQ,EAAE,CAAC;IAEhC,IAAM,iBAAiB,GAAe,WAAW,CAAC,UAAU,EAAE,CAAC;IAC/D,iBAAiB,CAAC,OAAO,GAAG,UAAA,KAAK;QAC/B,4BAA4B;QAC5B,OAAO,CAAC,IAAI,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;IACpD,CAAC,CAAC;IAEF,iBAAiB,CAAC,SAAS,GAAG;QAC5B,IAAM,MAAM,GAAG,iBAAiB,CAAC,MAAM,CAAC;QACxC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;YACX,kEAAkE;YAClE,mDAAmD;YACnD,IAAM,YAAY,GAAG,MAAM,CAAC,KAAK,CAAC;YAElC,QAAQ,CAAC,WAAW,CAClB,YAAY,CAAC,WAAW,EACxB,YAAY,CAAC,QAAQ,EACrB,YAAY,CAAC,UAAU,CACxB,CAAC;YAEF,MAAM,CAAC,QAAQ,EAAE,CAAC;QACpB,CAAC;QAAC,IAAI,CAAC,CAAC;YACN,EAAE,CAAC,KAAK,EAAE,CAAC;YACX,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;QACxC,CAAC;IACH,CAAC,CAAC;AACJ,CAAC;AAED;IACE,IAAM,OAAO,GAAqB,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;IAC9D,OAAO,CAAC,OAAO,GAAG,UAAS,KAAK;QAC9B,4BAA4B;IAC9B,CAAC,CAAC;IACF,OAAO,CAAC,SAAS,GAAG,UAAS,KAAK;QAChC,IAAM,EAAE,GAAG,OAAO,CAAC,MAAM,CAAC;QAC1B,QAAQ,CAAC,EAAE,CAAC,CAAC;IACf,CAAC,CAAC;AACJ,CAAC;AAEQ,0BAAO","file":"clean-v1-undefined.js","sourcesContent":["/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * There seems to have been a bug in the messaging SDK versions <= 4.9.x\n * where the IndexedDB model was using a database name of 'undefined'.\n *\n * In 4.10.x we changed the model implementation, but kept the database\n * name as it should have been. This however introduced an issue where\n * two tokens were pointing to the same underlying PushSubscription.\n *\n * This code will look for the undefined database and delete any of the\n * underlying tokens.\n */\n\nimport IIDModel from '../models/iid-model';\n\nconst OLD_DB_NAME = 'undefined';\nconst OLD_OBJECT_STORE_NAME = 'fcm_token_object_Store';\n\nfunction handleDb(db: IDBDatabase) {\n  if (!db.objectStoreNames.contains(OLD_OBJECT_STORE_NAME)) {\n    // We found a database with the name 'undefined', but our expected object\n    // store isn't defined.\n    return;\n  }\n\n  const transaction = db.transaction(OLD_OBJECT_STORE_NAME);\n  const objectStore = transaction.objectStore(OLD_OBJECT_STORE_NAME);\n\n  const iidModel = new IIDModel();\n\n  const openCursorRequest: IDBRequest = objectStore.openCursor();\n  openCursorRequest.onerror = event => {\n    // NOOP - Nothing we can do.\n    console.warn('Unable to cleanup old IDB.', event);\n  };\n\n  openCursorRequest.onsuccess = () => {\n    const cursor = openCursorRequest.result;\n    if (cursor) {\n      // cursor.value contains the current record being iterated through\n      // this is where you'd do something with the result\n      const tokenDetails = cursor.value;\n\n      iidModel.deleteToken(\n        tokenDetails.fcmSenderId,\n        tokenDetails.fcmToken,\n        tokenDetails.fcmPushSet\n      );\n\n      cursor.continue();\n    } else {\n      db.close();\n      indexedDB.deleteDatabase(OLD_DB_NAME);\n    }\n  };\n}\n\nfunction cleanV1() {\n  const request: IDBOpenDBRequest = indexedDB.open(OLD_DB_NAME);\n  request.onerror = function(event) {\n    // NOOP - Nothing we can do.\n  };\n  request.onsuccess = function(event) {\n    const db = request.result;\n    handleDb(db);\n  };\n}\n\nexport { cleanV1 };\n"]}